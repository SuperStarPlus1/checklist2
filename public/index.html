<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>משימות סגירת סניף - מערכת מלאה</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f0f2f5; direction: rtl; }
    header { text-align: center; margin-bottom: 20px; }
    header img { width: 150px; margin-bottom: 10px; }
    header h2 { font-size: 28px; color: #333; }
    .section { background: white; margin-bottom: 15px; padding: 15px; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.1); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .text-container { flex: 1 1 300px; }
    .add-image-btn { background: #2196f3; border: none; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; margin-right: 10px; display: flex; justify-content: center; align-items: center; transition: transform 0.2s; animation: pulse 2s infinite; }
    .add-image-btn:hover { transform: scale(1.2); }
    .add-image-btn img { width: 24px; height: 24px; filter: invert(100%); }
    .preview-img { width: 100px; height: 100px; object-fit: cover; margin: 5px; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
    .upload-status { margin-left: 10px; font-size: 20px; cursor: default; user-select: none; }
    .upload-status button { margin-left: 8px; font-size: 14px; cursor: pointer; }
    #taskCounter { position: fixed; top: 20px; left: 20px; background: #2196f3; color: white; padding: 10px 20px; border-radius: 50px; font-size: 16px; z-index: 1000; }
    @keyframes pulse { 0% { box-shadow: 0 0 5px yellow; } 50% { box-shadow: 0 0 15px yellow; } 100% { box-shadow: 0 0 5px yellow; } }
  </style>
</head>
<body>
  <div id="taskCounter">משימות שנותרו: 0</div>

  <header>
    <img src="logo.png" alt="Logo" />
    <h2>משימות סגירת סניף</h2>
  </header>

  <form id="checkForm" onsubmit="event.preventDefault();">
    <div class="section"><label>תאריך ושעה:</label><input type="text" id="dateTime" readonly /></div>
    <div class="section"><label>שם עובד:</label><input type="text" id="employeeName" required /></div>
    <div id="checklist"></div>
    <button type="submit" style="margin-top:20px; padding: 10px 30px; font-size: 18px; background-color:#2196f3; color:white; border:none; border-radius:8px;">שלח טופס בקרה</button>
  </form>

<script>
  const items = [
    { text: "לוודא שכל הקרטונים בדחסן", requireImage: true },
    { text: "להוציא עגלות מהמחסן", requireImage: false },
    { text: "לוודא עם עובד מחלקת ירקות חיבור מלגזה לטעינה", requireImage: true },
    { text: "סגירת דלת מחסן מזרחית", requireImage: false },
    { text: 'כיבוי אורות ממ"ד', requireImage: false },
    { text: "חיבור מכונת שטיפה לחשמל", requireImage: true },
    { text: "כיבוי אור שירותים", requireImage: false },
    { text: "כיבוי אורות מקררים", requireImage: false },
    { text: "צילום טמפרוטורת של מקררי חלב", requireImage: true },
    { text: "סגירת דלת מחסן אמצעית", requireImage: false },
    { text: "צילום טמפרטורטת של מקפיא עומד", requireImage: true },
    { text: "מעבר בין המדפים לוודא שאין חריגים ולוודא ניקיון מעברים", requireImage: false },
    { text: "סגירת דלת מחסן אחורית (ליד המקרר)", requireImage: false },
    { text: "לוודא שכל המקררי גיבוי ומקפאים סגורים", requireImage: true },
    { text: "צילום טמפרטורות של מקררי גיבוי", requireImage: true },
    { text: "לוודא שאין עגלות בתוך הסופר", requireImage: false },
    { text: "פינוי פחים כולל פח קופה ראשית", requireImage: false },
    { text: "כיבוי אורות מחלקת שתייה וחומרי ניקוי", requireImage: false },
    { text: "כיבוי מזגנים בחלק האחורי", requireImage: true },
    { text: "צילום מדף לחם ושליחה לאשרף", requireImage: true },
    { text: "להוציא עגלת חזרות לחם", requireImage: true },
    { text: "לוודא נעילת שער חצר ארגזים", requireImage: false },
    { text: "לוודא שאין עגלות שלא במקומם", requireImage: false },
    { text: "כיבוי מזגנים", requireImage: true },
    { text: "כיבוי אורות כניסה והדלקת תאורת לילה", requireImage: false },
    { text: "כיבוי אורות ראשי", requireImage: false },
    { text: "לוודא שאין הפרעה לתריס הראשי. לסגור את התריס ולוודא שנסגר עד הסוף", requireImage: true }
  ];

  const uploadedFiles = {};
  const folderName = new Date().toISOString().split('T')[0];

  // הצגת התאריך והשעה הנוכחיים
  document.getElementById("dateTime").value = new Date().toLocaleString();

  // יצירת רשימת הסעיפים בטופס
  function createChecklist() {
    const checklistDiv = document.getElementById("checklist");
    items.forEach((item, idx) => {
      const section = document.createElement("div");
      section.className = "section";

      const textContainer = document.createElement("div");
      textContainer.className = "text-container";
      textContainer.innerHTML = `<label><input type="checkbox" id="item${idx}"> ${item.text}</label>`;
      section.appendChild(textContainer);

      if (item.requireImage) {
        const addBtn = document.createElement("button");
        addBtn.type = "button";
        addBtn.className = "add-image-btn";
        addBtn.innerHTML = '<img src="https://cdn-icons-png.flaticon.com/512/685/685655.png" />';
        addBtn.onclick = () => promptImageUpload(idx);
        section.appendChild(addBtn);

        const imgContainer = document.createElement("div");
        imgContainer.id = `imgContainer${idx}`;
        section.appendChild(imgContainer);

        uploadedFiles[idx] = [];
      }

      checklistDiv.appendChild(section);
      document.getElementById(`item${idx}`).addEventListener("change", updateTaskCounter);
    });
  }

  // עדכון ספירת המשימות שנותרו
  function updateTaskCounter() {
    const total = items.length;
    let done = 0;
    for(let i=0; i<total; i++) {
      if(document.getElementById(`item${i}`).checked) done++;
    }
    document.getElementById("taskCounter").innerText = `משימות שנותרו: ${total - done}`;
  }

  // פתיחת חלון בחירת הקובץ
  function promptImageUpload(idx) {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.capture = "environment";

    input.onchange = async e => {
      const file = e.target.files[0];
      if (!file) return;

      if(uploadedFiles[idx].length >= 9) {
        alert("ניתן להעלות עד 9 תמונות לכל סעיף בלבד.");
        return;
      }

      const reader = new FileReader();
      reader.onload = async () => {
        const base64 = reader.result.split(",")[1];
        const fileName = `item${idx}_image${uploadedFiles[idx].length + 1}.jpg`;

        await uploadImage(idx, base64, fileName, reader.result);
      };
      reader.readAsDataURL(file);
    };
    input.click();
  }

  // העלאת תמונה עם טיפול בשגיאות והצגת כפתור ניסיון חוזר
  async function uploadImage(idx, base64, fileName, dataUrl) {
    const imgContainer = document.getElementById(`imgContainer${idx}`);

    try {
      const res = await fetch("/api/upload", {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ folderName, fileName, fileData: base64 })
      });

      if (res.ok) {
        uploadedFiles[idx].push(fileName);

        // הוספת תמונה חדשה לתצוגה, לא מוחקת תמונות קודמות
        const img = document.createElement("img");
        img.src = dataUrl;
        img.className = "preview-img";

        // הסרת הודעות שגיאה או כפתורים קודמים אם קיימים
        const existingErrors = imgContainer.querySelectorAll(".upload-error");
        existingErrors.forEach(el => el.remove());

        imgContainer.appendChild(img);

        // סימון הסעיף כסומן
        document.getElementById(`item${idx}`).checked = true;
        updateTaskCounter();

      } else {
        throw new Error("העלאה נכשלה בשרת");
      }

    } catch (err) {
      // הצגת הודעת שגיאה עם כפתור ניסיון חוזר
      const errorSpan = document.createElement("span");
      errorSpan.className = "upload-error upload-status";
      errorSpan.style.color = "red";
      errorSpan.style.marginLeft = "10px";
      errorSpan.textContent = "❌ העלאה נכשלה ";

      const retryBtn = document.createElement("button");
      retryBtn.textContent = "נסה שוב";
      retryBtn.style.marginLeft = "5px";
      retryBtn.onclick = () => uploadImage(idx, base64, fileName, dataUrl);

      errorSpan.appendChild(retryBtn);
      imgContainer.appendChild(errorSpan);
    }
  }

  // אתחול ראשוני
  createChecklist();
  updateTaskCounter();
</script>

</body>
</html>
